/******************** (C) COPYRIGHT 2012 BOOLESION.NET ***************************
* 产品名称: 布尔创51开发板 E1101
* 文件名称: vs1003.c
* 程序作者: BOOLESION.NET 布尔创(BOOLESION)电子科技 - NETC (陈建长)
* 程序版本: V1.2
* 编制日期: 2012/03/20
* 功能描述: VS1003 音频解码 驱动程序.
**********************************************************************************/

/* Includes ---------------------------------------------------------------------*/
#include "includes.h"	  /* 使用VS1003需要包含的头文件,内部有VS1003函数的声明 */



/* 变量声明 ---------------------------------------------------------------------*/
INT8U bdata sdat;
sbit sdat7=sdat^7;
sbit sdat6=sdat^6;
sbit sdat5=sdat^5;
sbit sdat4=sdat^4;
sbit sdat3=sdat^3;
sbit sdat2=sdat^2;
sbit sdat1=sdat^1;
sbit sdat0=sdat^0;

/*********************************************************************************
** 函数名称: void VS_delay(INT16U time).
** 功能描述: SPI发送数据函数.
** 输入参数: INT16U time 时间长短.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_delay(INT16U time) 
{
	while(time--);
}

#if 0
/*
**vs的指令表
*/
static const INT16U code DataTab[943] = {
0x8050, 0x3613, 0x0024, 0x3e00, 0x3801, 0x0000, 0x16d7, 0xf400,0x55c0, 0x0000, 0x0a17, 0xf400, 0x57c0, 0x0006, 0x5017, 0xb080,
0x0024, 0x3f00, 0x0024, 0x2000, 0x0000, 0x36f0, 0x1801, 0x2800,0x31c0, 0x805c, 0x3e12, 0xb817, 0x3e12, 0x3815, 0x3e05, 0xb814,
0x3615, 0x0024, 0x0000, 0x800a, 0x3e10, 0x3801, 0x0006, 0x0000,0x3e10, 0xb803, 0x0000, 0x0303, 0x3e11, 0x3805, 0x3e11, 0xb807,
0x3e14, 0x3812, 0xb884, 0x130c, 0x3410, 0x4024, 0x4112, 0x10d0,0x4010, 0x008c, 0x4010, 0x0024, 0xf400, 0x4012, 0x3000, 0x3840,
0x3009, 0x3801, 0x0000, 0x0041, 0xfe02, 0x0024, 0x2900, 0x8440,0x48b2, 0x0024, 0x36f3, 0x0844, 0x6306, 0x8845, 0xae3a, 0x8840,
0xbf8e, 0x8b41, 0xac32, 0xa846, 0xffc8, 0xabc7, 0x3e01, 0x7800,0xf400, 0x4480, 0x6090, 0x0024, 0x6090, 0x0024, 0xf400, 0x4015,
0x3009, 0x3446, 0x3009, 0x37c7, 0x3009, 0x1800, 0x3009, 0x3844,0x48b3, 0xe1e0, 0x4882, 0x4040, 0xfeca, 0x0024, 0x5ac2, 0x0024,
0x5a52, 0x0024, 0x4cc2, 0x0024, 0x48ba, 0x4040, 0x4eea, 0x4801,0x4eca, 0x9800, 0xff80, 0x1bc1, 0xf1eb, 0xe3e2, 0xf1ea, 0x184c,
0x4c8b, 0xe5e4, 0x48be, 0x9804, 0x488e, 0x41c6, 0xfe82, 0x0024,0x5a8e, 0x0024, 0x525e, 0x1b85, 0x4ffe, 0x0024, 0x48b6, 0x41c6,
0x4dd6, 0x48c7, 0x4df6, 0x0024, 0xf1d6, 0x0024, 0xf1d6, 0x0024,0x4eda, 0x0024, 0x0000, 0x0fc3, 0x2900, 0x8440, 0x4e82, 0x0024,
0x4084, 0x130c, 0x0006, 0x0100, 0x3440, 0x4024, 0x4010, 0x0024,0xf400, 0x4012, 0x3200, 0x4024, 0xb132, 0x0024, 0x4214, 0x0024,
0xf224, 0x0024, 0x6230, 0x0024, 0x0001, 0x0001, 0x2800, 0x2b49,0x0000, 0x0024, 0xf400, 0x40c2, 0x3200, 0x0024, 0xff82, 0x0024,
0x48b2, 0x0024, 0xb130, 0x0024, 0x6202, 0x0024, 0x003f, 0xf001,0x2800, 0x2e51, 0x0000, 0x1046, 0xfe64, 0x0024, 0x48be, 0x0024,
0x2800, 0x2f40, 0x3a01, 0x8024, 0x3200, 0x0024, 0xb010, 0x0024,0xc020, 0x0024, 0x3a00, 0x0024, 0x36f4, 0x1812, 0x36f1, 0x9807,
0x36f1, 0x1805, 0x36f0, 0x9803, 0x36f0, 0x1801, 0x3405, 0x9014,0x36f3, 0x0024, 0x36f2, 0x1815, 0x2000, 0x0000, 0x36f2, 0x9817,
0x80c7, 0x3e12, 0xb817, 0x3e12, 0x3815, 0x3e05, 0xb814, 0x3625,0x0024, 0x0000, 0x800a, 0x3e10, 0x7802, 0x3e10, 0xf804, 0x3e11,
0x7810, 0x3e14, 0x7813, 0x0006, 0x0051, 0x3e13, 0xf80e, 0x3e13,0x4024, 0x3009, 0x3840, 0x3009, 0x3852, 0x2919, 0x64c0, 0x0006,
0x06d0, 0x3100, 0x5bd2, 0x0006, 0x55d1, 0x3009, 0x1800, 0x3009,0x0402, 0x6126, 0x0024, 0x0006, 0x00d1, 0x2800, 0x4d05, 0xb882,
0x0024, 0x0006, 0x0011, 0x3009, 0x3850, 0x0006, 0x0010, 0x3009,0x3800, 0x291d, 0x5800, 0x0000, 0x1800, 0x0006, 0x0010, 0xb882,
0x0024, 0x291d, 0x5b00, 0x0000, 0x1700, 0x0000, 0x0301, 0x3900,0x5bc0, 0x0006, 0x55d1, 0x3009, 0x1bd0, 0x3009, 0x0404, 0x0006,
0x0051, 0x2800, 0x3d00, 0x3901, 0x0024, 0x4448, 0x0401, 0x4192,0x0024, 0x6498, 0x2401, 0x001f, 0x4001, 0x6412, 0x0024, 0x0006,
0x0011, 0x2800, 0x3c51, 0x0000, 0x058e, 0x2400, 0x4c0e, 0x0000,0x0013, 0x0006, 0x0051, 0x0006, 0x1a03, 0x3100, 0x4024, 0xf212,
0x44c4, 0x4346, 0x0024, 0xf400, 0x40d5, 0x3500, 0x8024, 0x612a,0x0024, 0x0000, 0x0024, 0x2800, 0x4c51, 0x0000, 0x0024, 0x3613,
0x0024, 0x3100, 0x3800, 0x291d, 0x8000, 0xf200, 0x0024, 0x003f,0xfec2, 0x4082, 0x4411, 0x3113, 0x1bc0, 0xa122, 0x0024, 0x0000,
0x2002, 0x6124, 0x2401, 0x0000, 0x1002, 0x2800, 0x4608, 0x0000,0x0024, 0x003f, 0xf802, 0x3100, 0x4024, 0xb124, 0x0024, 0x2800,
0x4bc0, 0x3900, 0x8024, 0x6124, 0x0024, 0x0000, 0x0802, 0x2800,0x4848, 0x0000, 0x0024, 0x003f, 0xfe02, 0x3100, 0x4024, 0xb124,
0x0024, 0x2800, 0x4bc0, 0x3900, 0x8024, 0x6124, 0x0024, 0x0000,0x0402, 0x2800, 0x4a88, 0x0000, 0x0024, 0x003f, 0xff02, 0x3100,
0x4024, 0xb124, 0x0024, 0x2800, 0x4bc0, 0x3900, 0x8024, 0x6124,0x0401, 0x003f, 0xff82, 0x2800, 0x4bc8, 0xb124, 0x0024, 0x3900,
0x8024, 0xb882, 0x8c4c, 0x3830, 0x4024, 0x0006, 0x0091, 0x3904,0xd84c, 0x0006, 0x00d1, 0x0000, 0x0013, 0x3100, 0x904c, 0x4202,
0x9bcc, 0x39f0, 0x4024, 0x3100, 0x4024, 0x3c00, 0x4024, 0xf400,0x44c1, 0x34f0, 0x8024, 0x6126, 0x0024, 0x0006, 0x06d0, 0x2800,
0x5dd8, 0x4294, 0x0024, 0x2400, 0x5d82, 0x0000, 0x0024, 0xf400,0x4411, 0x3123, 0x0024, 0x3100, 0x8024, 0x4202, 0x0024, 0x4182,
0x2401, 0x0000, 0x2002, 0x2800, 0x5d89, 0x0000, 0x0024, 0x3013,0x184c, 0x30f0, 0x7852, 0x6124, 0xb850, 0x0006, 0x0001, 0x2800,
0x5588, 0x4088, 0x44c2, 0x4224, 0x0024, 0x4122, 0x0024, 0x4122,0x0024, 0xf400, 0x4051, 0x2900, 0x7440, 0x0000, 0x56c8, 0x4224,
0x0024, 0x4122, 0x0024, 0x4122, 0x0024, 0x2900, 0x69c0, 0xf400,0x4051, 0x0004, 0x0002, 0x3009, 0x1bd0, 0x3023, 0x1bd2, 0x30e0,
0x4024, 0x6124, 0x0024, 0x0000, 0x4002, 0x2800, 0x5988, 0x0000,0x0024, 0x0000, 0x0001, 0x3820, 0x4024, 0x30e0, 0x4024, 0x6124,
0x0001, 0x003f, 0xff42, 0x2800, 0x5d88, 0x4182, 0x0024, 0x0000,0x0024, 0x2800, 0x5d95, 0x0000, 0x0024, 0x3613, 0x0024, 0x3e14,
0xc024, 0x2900, 0x1700, 0x3e14, 0x0024, 0x36e3, 0x008c, 0x30e0,0x4024, 0xfe22, 0x4411, 0x48b6, 0x048c, 0x3900, 0x8024, 0x3033,
0x0c4c, 0x0006, 0x0011, 0x6892, 0x04c2, 0xa122, 0x0402, 0x6126,0x0024, 0x0006, 0x0093, 0x2800, 0x6701, 0x0000, 0x0024, 0xb882,
0x184c, 0x3413, 0x3812, 0x0006, 0x00d2, 0x3a00, 0x5bd2, 0x3300,0x4024, 0x0000, 0x0013, 0x3c00, 0x4024, 0xf400, 0x44c1, 0x34f0,
0x8024, 0x6126, 0x0024, 0x0006, 0x0111, 0x2800, 0x6718, 0x4294,0x0024, 0x2400, 0x66c2, 0x0000, 0x0024, 0x0003, 0xf001, 0x3101,
0x0024, 0xb412, 0x0024, 0x0028, 0x0001, 0x2800, 0x66c5, 0x6144,0x0024, 0x0004, 0x0002, 0x2800, 0x6681, 0x4422, 0x0024, 0x0000,
0x1002, 0x6422, 0x0024, 0x2800, 0x66c0, 0x3900, 0x4024, 0x3900,0x4024, 0x3113, 0x0c4c, 0x36f3, 0x4024, 0x36f3, 0xd80e, 0x36f4,
0x5813, 0x36f1, 0x5810, 0x36f0, 0xd804, 0x36f0, 0x5802, 0x3405,0x9014, 0x36f3, 0x0024, 0x36f2, 0x1815, 0x2000, 0x0000, 0x36f2,
0x9817, 0x1868, 0x0032, 0x004f, 0x007e, 0x00c8, 0x013d, 0x01f8,0x0320, 0x04f6, 0x07e0, 0x0c80, 0x13d8, 0x1f7f, 0x3200, 0x4f5f,
0x61a8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,0x0000, 0x81a7, 0x3e12, 0xb814, 0x0000, 0x800a, 0x3e10, 0x3801,
0x3e10, 0xb803, 0x3e11, 0x7806, 0x3e11, 0xf813, 0x3e13, 0xf80e,0x3e13, 0x4024, 0x3e04, 0x7810, 0x449a, 0x0040, 0x0001, 0x0003,
0x2800, 0x7304, 0x4036, 0x03c1, 0x0003, 0xffc2, 0xb326, 0x0024,0x0018, 0x0042, 0x4326, 0x4495, 0x4024, 0x40d2, 0x0000, 0x0180,
0xa100, 0x4090, 0x0010, 0x0fc2, 0x4204, 0x0024, 0xbc82, 0x4091,0x459a, 0x0024, 0x0000, 0x0054, 0x2800, 0x7204, 0xbd86, 0x4093,
0x2400, 0x71c5, 0xfe01, 0x5e0c, 0x5c43, 0x5f2d, 0x5e46, 0x020c,0x5c56, 0x8a0c, 0x5e53, 0x5e0c, 0x5c43, 0x5f2d, 0x5e46, 0x020c,
0x5c56, 0x8a0c, 0x5e52, 0x0024, 0x4cb2, 0x4405, 0x0018, 0x0044,0x654a, 0x0024, 0x2800, 0x8000, 0x36f4, 0x5810, 0x81d1, 0x3e12,
0xb814, 0x0000, 0x800a, 0x3e10, 0x3801, 0x3e10, 0xb803, 0x3e11,0x7806, 0x3e11, 0xf813, 0x3e13, 0xf80e, 0x3e13, 0x4024, 0x3e04,
0x7810, 0x449a, 0x0040, 0x0000, 0x0803, 0x2800, 0x7ec4, 0x30f0,0x4024, 0x0fff, 0xfec2, 0xa020, 0x0024, 0x0fff, 0xff02, 0xa122,
0x0024, 0x4036, 0x0024, 0x0000, 0x1fc2, 0xb326, 0x0024, 0x0010,0x4002, 0x4326, 0x4495, 0x4024, 0x40d2, 0x0000, 0x0180, 0xa100,
0x4090, 0x0010, 0x0042, 0x4204, 0x0024, 0xbc82, 0x4091, 0x459a,0x0024, 0x0000, 0x0054, 0x2800, 0x7dc4, 0xbd86, 0x4093, 0x2400,
0x7d85, 0xfe01, 0x5e0c, 0x5c43, 0x5f2d, 0x5e46, 0x0024, 0x5c56,0x0024, 0x5e53, 0x5e0c, 0x5c43, 0x5f2d, 0x5e46, 0x0024, 0x5c56,
0x0024, 0x5e52, 0x0024, 0x4cb2, 0x4405, 0x0010, 0x4004, 0x654a,0x9810, 0x0000, 0x0144, 0xa54a, 0x1bd1, 0x0006, 0x0013, 0x3301,
0xc444, 0x687e, 0x2005, 0xad76, 0x8445, 0x4ed6, 0x8784, 0x36f3,0x64c2, 0xac72, 0x8785, 0x4ec2, 0xa443, 0x3009, 0x2440, 0x3009,
0x2741, 0x36f3, 0xd80e, 0x36f1, 0xd813, 0x36f1, 0x5806, 0x36f0,0x9803, 0x36f0, 0x1801, 0x2000, 0x0000, 0x36f2, 0x9814, 0x8211,
0x4c82, 0x0024, 0x0000, 0x0024, 0x2000, 0x0005, 0xf5c2, 0x0024,0x0000, 0x0980, 0x2000, 0x0000, 0x6010, 0x0024, 0x0050
};
#endif /* DataTab */
/*********************************************************************************
** 函数名称: void VS_Write_Reg(INT8U addr,INT16U vsdata).
** 功能描述: 向VS1003写入数据.
** 输入参数: INT8U addr 功能寄存器的地址,INT16U vsdata 写入字节.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_Write_Reg(INT8U addr,INT16U vsdata)
{  
	VS_DREQ=1;           		     /* 51单片机IO作输入时先置为1 */
	while(!VS_DREQ);     		     /* VS的DREQ为高电平时才接收数据 */
	VS_CS=0;            		     /* 打开片选 */
	VS_WriteByte(VS_WRITE_CMD);  	 /* 写入操作码(功能寄存器写操作) */
	VS_WriteByte(addr);  		     /* 写入寄存器地址 */
	// VS_WriteByte(hdat);  		 /* 写入高字节 */
	// VS_WriteByte(ldat);  		 /* 写入低字节 */ 
	VS_WriteByte(vsdata>>8);
	VS_WriteByte(vsdata&0xff);
	VS_CS=1;            		     /* 关闭片选 */
}

#if 1

/*********************************************************************************
** 函数名称: INT16U VS_Read_Reg(INT8U addr).
** 功能描述: 从VS的功能寄存器中读取数据,一个字.
** 输入参数: INT8U addr 功能寄存器的地址.         
** 输出参数: None.
** 返回参数: return temp读到的字,2字节.
**********************************************************************************/
INT16U VS_Read_Reg(INT8U addr) 
{
	INT16U temp=0;
	VS_DREQ=1;               
	while(!VS_DREQ); 			/* VS的DREQ为高电平时才接收数据 */
	VS_CS=0;	      			/* 打开片选 */
	VS_WriteByte(VS_Read);  	/* 读出操作码(功能寄存器读操作) */
	VS_WriteByte(addr);  		/* 写入寄存器地址 */
	temp =VS_ReadByte();  		/* 读高字节 */
	temp<<=8;
	temp|=VS_ReadByte(); 		/* 读取低字节,与高字节拼成一个字 */
	VS_CS=1;	      			/* 关闭片选 */
	return temp;     
}
#endif /* VS_Read_Reg */

#if 0
/*********************************************************************************
** 函数名称: void VsLoadPatch(void).
** 功能描述: 加载频谱分析的代码到VS1003.
** 输入参数: None.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VsLoadPatch(void)
{
	INT16U i;
	for (i=0;i<sizeof(DataTab);i++)
	{
		switch(i)
		{
			case 0:
			case 25:
			case 240:
			case 689:
			case 713:
			case 798:
			case 927:
				VS_Write_Reg(7,DataTab[i]); 
				break;
			case 942:
				VS_Write_Reg(10,DataTab[i]); 
				break;
			default:
				VS_Write_Reg(6,DataTab[i]); 
		}		
	}
	VS_delay(500);	
}

/*********************************************************************************
** 函数名称: void VsGetSpec(unsigned short *p).
** 功能描述: 得到14字节的频谱数据.
** 输入参数: unsigned short *p.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VsGetSpec(unsigned short *p)
{
	INT8U i;
	
	VS_Write_Reg(VS_WRAMADDR,0x1804);                                                                                             
	for (i=0;i<14;i++) 
	{                                                                               
		*p++=VS_Read_Reg(VS_WRAM); /* &0x63,取小于100的数 */   
	} 
}
#endif /* VsGetSpec */

/*********************************************************************************
** 函数名称: void VsSetVolume(INT8U volume) .
** 功能描述: 设置音量	 1 - 48.
** 输入参数: INT8U volume  1 - 48 .         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VsSetVolume(INT8U volume) 
{ 
	volume = volume * 0x03; 
	VS_Write_Reg(VS_VOL,((volume<<8)|volume));
}

/*********************************************************************************
** 函数名称: void VS_Init(void).
** 功能描述: VS1003软复位及初始化.
** 输入参数: None.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_Init(void)
{
	VS_RST=1; 
	VS_delay(100);
	VS_RST=0;
	VS_delay(100);
	VS_RST=1;    				      /* 硬件复位，VS_RST低电平有效 */
	VS_delay(100);
	
	VS_Write_Reg(VS_MODE  ,0x0804);  /* 软件复位，向0号寄存器写入0x0804   SM_SDINEW为1   SM_RESET为1 */
	VS_Write_Reg(VS_CLOCKF,0x9800);  /* 时钟设置，向3号寄存器写入0x9800   SC_MULT  为4   SC_ADD  为3   SC_FREQ为0 */
	VS_Write_Reg(VS_VOL   ,0x7070);  /* 音量设置，左右声道均中等音量 */  
	VS_Write_Reg(0x02	   ,0x7aaa); 
	VS_DCS=0;	     			      /* 打开数据片选 */
	VS_WriteByte(0);    		      /* 写入数据，这里写入4个0，是无关数据，用来启动数据传输 */
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_DCS=1;	    			      /* 关闭数据片选 */
}

/*********************************************************************************
** 函数名称: void VS_Send_Dat32(INT8U *dat) .
** 功能描述: 向VS1003写入32个字节的音频数据.
** 输入参数: INT8U *dat 音频数据.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_Send_Dat32(INT8U *dat) 
{
	INT8U i=0;
	VS_DREQ=1;
	VS_DCS=0;	   				/* 打开数据片选，即开启SDI传输 */
	while(!VS_DREQ);  			/* VS1003的DREQ为高才能写入数据 */
	for(i=0;i<32;i++)
	VS_WriteByte(*(dat+i));	/* 通过SPI向VS1003写入32个字节的音频数据 */
	VS_DCS=1;	   				/* 打开数据片选，即开启SDI传输 */
}

#if 0
/*********************************************************************************
** 函数名称: void VS_Flush_Buffer(void).
** 功能描述: 向VS1003写入2048个0,清空缓冲,为下一首mp3做准备.
** 输入参数: None.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_Flush_Buffer(void) 
{
	uchar i,j=0;
	VS_DCS=0;	   				/* 打开数据片选，即开启SDI传输 */
	for(i=0;i<64;i++)
	{
	VS_DREQ=1;
	while(!VS_DREQ);  			/* VS1003的DREQ为高才能写入数据 */
	for(j=0;j<32;j++)
	VS_WriteByte(0);			/* 通过SPI向VS1003写入32个字节的0 */
	}
	VS_DCS=1;        			/* 关闭数据片选 */
}
#endif /* VS_Flush_Buffer */

/*********************************************************************************
** 函数名称: void VS_SinTest(INT16U x).
** 功能描述: 正弦测试函数,检查vs1003是否正常.
** 输入参数: INT8U x 正弦波频率.         
** 输出参数: None.
** 返回参数: None.
**********************************************************************************/
void VS_SinTest(INT16U x)
{ 
	VS_Write_Reg(0x00,0x0820);	    /* 启动测试，向0号寄存器写入0x0820   SM_SDINEW为1   SM_TEST为1 */
	VS_DREQ=1;
	while(!VS_DREQ);   			/* 等待DREQ变为高电平 */
	VS_DCS=0;	        			/* 打开数据片选 */
	VS_WriteByte(0x53);			/* 写入以下8个字节,进入正弦测试 */
	VS_WriteByte(0xef); 
	VS_WriteByte(0x6e);
	VS_WriteByte(x);   			/* 参数x用来调整正弦测试中正弦波的频率 */
	VS_WriteByte(0);   			
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_delay(60000);      			/* 这里延时一段时间,可以听到“正弦音” */
	VS_delay(60000);
	VS_delay(60000);
	VS_delay(60000);
	VS_delay(60000);
	VS_delay(60000);
	VS_WriteByte(0x45);			 /* 写入以下8个字节,退出正弦测试 */
	VS_WriteByte(0x78); 
	VS_WriteByte(0x69);
	VS_WriteByte(0x74);
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_WriteByte(0);
	VS_DCS=1;	    				 /* 关闭数据片选 */
}


